<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (‡∏ü‡∏£‡∏µ)</title>

  <!-- Bootstrap 5 (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡πÅ‡∏•‡∏∞ responsive) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tesseract.js v5 (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    body { font-family: ui-rounded, system-ui, "Kanit", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
    .card { border-radius: 1rem; }
    video, canvas, img { width: 100%; border-radius: 0.75rem; }
    .pill { border-radius: 999px; }
    .small-muted { font-size: 0.9rem; color: #64748b; }
    .required::after { content: " *"; color: #ef4444; }
    .ocr-log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow:auto; background:#0b1020; color:#d5e1ff; padding:12px; border-radius:8px;}
  </style>
</head>
<body class="bg-light">
  <div class="container py-4 py-md-5">
    <div class="row g-4">
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h1 class="h4 mb-3">üì∏ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</h1>
            <p class="small-muted mb-3">‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î (‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏î‡πâ) ‚Äî ‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Drive ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>

            <div class="d-grid gap-2 mb-3">
              <button id="btnOpenCamera" class="btn btn-primary pill">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
              <button id="btnTakePhoto" class="btn btn-success pill" disabled>‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
              <input id="filePicker" type="file" accept="image/*" capture="environment" class="form-control pill" />
            </div>

            <div class="mb-3">
              <video id="video" autoplay playsinline class="d-none"></video>
              <canvas id="canvas" class="d-none"></canvas>
              <img id="preview" alt="preview" class="d-none" />
            </div>

            <div class="d-grid gap-2 mb-2">
              <button id="btnOCR" class="btn btn-outline-secondary pill" disabled>‡∏£‡∏±‡∏ô OCR (‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</button>
              <button id="btnRetake" class="btn btn-outline-danger pill" disabled>‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
            </div>

            <div class="ocr-log d-none" id="ocrLog"></div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h5 mb-3">üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>

            <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á -->
            <form id="regForm" autocomplete="off">
              <div class="mb-3">
                <label class="form-label required">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£)</label>
                <input type="text" class="form-control" id="fullName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" required>
              </div>

              <div class="mb-3">
                <label class="form-label required">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å</label>
                <input type="text" class="form-control" id="idNumber" inputmode="numeric" pattern="\\d{13}" placeholder="0XXXXXXXXXXXXX" required>
                <div class="form-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å</div>
              </div>

              <div class="mb-3">
                <label class="form-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <input type="text" class="form-control" id="dob" placeholder="‡πÄ‡∏ä‡πà‡∏ô 01/01/2540 ‡∏´‡∏£‡∏∑‡∏≠ 1997-01-01">
              </div>

              <div class="mb-3">
                <label class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <textarea class="form-control" id="address" rows="2" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå"></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                <textarea class="form-control" id="note" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
              </div>

              <div class="alert alert-warning">
                ‚ö†Ô∏è <b>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</b>:
                ‡πÇ‡∏õ‡∏£‡∏î‡∏ñ‡πà‡∏≤‡∏¢/‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå/‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Å‡πà‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
              </div>

              <div class="d-grid gap-2">
                <button type="submit" id="btnSubmit" class="btn btn-primary pill" disabled>‡∏™‡πà‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
              </div>
            </form>

            <hr class="my-4"/>

            <div class="small-muted">
              ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="statusText">‡∏£‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/** ========= CONFIG ========= **/
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwIaL7YlYoyTwnfqv_hbR2TNHqbsoQsr2L4dSkOtkxaPXAbT3Dlq3_6kj8FluuB8M3N/exec"; // ‚Üê ‡πÉ‡∏™‡πà URL ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy Apps Script
const MAX_WIDTH = 1400;         // ‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
const JPEG_QUALITY = 0.82;      // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ
const OCR_LANGS = "tha+eng";    // ‡∏†‡∏≤‡∏©‡∏≤ OCR

/** ========= ELEMENTS ========= **/
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const preview = document.getElementById('preview');
const filePicker = document.getElementById('filePicker');
const btnOpenCamera = document.getElementById('btnOpenCamera');
const btnTakePhoto = document.getElementById('btnTakePhoto');
const btnRetake = document.getElementById('btnRetake');
const btnOCR = document.getElementById('btnOCR');
const btnSubmit = document.getElementById('btnSubmit');
const statusText = document.getElementById('statusText');
const ocrLog = document.getElementById('ocrLog');

const inputFullName = document.getElementById('fullName');
const inputIdNumber = document.getElementById('idNumber');
const inputDob = document.getElementById('dob');
const inputAddress = document.getElementById('address');
const inputNote = document.getElementById('note');

let stream = null;
let currentImageDataUrl = null;
let rawOcrText = "";

/** ========= HELPERS ========= **/
function setStatus(msg) { statusText.textContent = msg; }
function show(el) { el.classList.remove('d-none'); }
function hide(el) { el.classList.add('d-none'); }

function drawToCanvas(img) {
  const ratio = img.width / img.height;
  let targetW = img.width;
  let targetH = img.height;
  if (targetW > MAX_WIDTH) {
    targetW = MAX_WIDTH;
    targetH = Math.round(MAX_WIDTH / ratio);
  }
  canvas.width = targetW;
  canvas.height = targetH;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, targetW, targetH);
}

function fileToImage(file) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.src = URL.createObjectURL(file);
  });
}

function dataURLToFile(dataUrl, filename) {
  const arr = dataUrl.split(",");
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]); let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while (n--) u8arr[n] = bstr.charCodeAt(n);
  return new File([u8arr], filename, { type: mime });
}

function extractLikelyFields(text) {
  // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î, ‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≥
  const cleaned = text.replace(/\s+/g, ' ').trim();

  // ‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ 13 ‡∏´‡∏•‡∏±‡∏Å
  const idMatch = cleaned.match(/\b\d{13}\b/);

  // ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏ó‡∏¢ (‡πÄ‡∏î‡∏≤‡∏á‡πà‡∏≤‡∏¢ ‡πÜ: ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á) ‚Äî ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤: ‡∏ô‡∏≤‡∏¢ ‡∏ô‡∏≤‡∏á ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢ ‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á
  const nameMatch = cleaned.match(/(‡∏ô‡∏≤‡∏¢|‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß|‡∏ô‡∏≤‡∏á|‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢|‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á)\s+[‡∏Å-‡πôA-Za-z]+(?:\s+[‡∏Å-‡πôA-Za-z]+){0,2}/);

  // ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á ‡∏û.‡∏®./‡∏Ñ.‡∏®.
  const dobMatch = cleaned.match(/(\d{1,2}[/\-\.]\d{1,2}[/\-\.]\d{2,4})/);

  // Address: ‡∏´‡∏≤ ‚Äú‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‚Äù ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ ‡πÜ ‡πÅ‡∏ö‡∏ö‡∏´‡∏¢‡∏≤‡∏ö ‡πÜ
  let address = "";
  const addrIdx = cleaned.indexOf("‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà");
  if (addrIdx !== -1) {
    address = cleaned.slice(addrIdx).replace(/^‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà[:\s]*/,'').slice(0, 120);
  }

  return {
    idNumber: idMatch ? idMatch[0] : "",
    fullName: nameMatch ? nameMatch[0] : "",
    dob: dobMatch ? dobMatch[1] : "",
    address: address
  };
}

/** ========= CAMERA & FILE ========= **/
btnOpenCamera.addEventListener('click', async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    show(video);
    hide(preview);
    btnTakePhoto.disabled = false;
    btnRetake.disabled = false;
    setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‚Ä¶ ‡∏à‡∏±‡∏î‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏ü‡∏£‡∏° ‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏≠ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏°‡∏ä‡∏±‡∏î");
  } catch (e) {
    console.error(e);
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ó‡∏ô");
  }
});

btnTakePhoto.addEventListener('click', () => {
  // ‡πÅ‡∏Ñ‡∏õ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
  const w = video.videoWidth;
  const h = video.videoHeight;
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, w, h);

  // ‡∏¢‡πà‡∏≠/‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î
  const img = new Image();
  img.onload = () => {
    drawToCanvas(img);
    currentImageDataUrl = canvas.toDataURL('image/jpeg', JPEG_QUALITY);
    preview.src = currentImageDataUrl;
    hide(video);
    show(preview);
    btnOCR.disabled = false;
    btnSubmit.disabled = false;
    setStatus("‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ô OCR ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ");
  };
  img.src = canvas.toDataURL('image/png'); // ‡∏Å‡πâ‡∏≤‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏û‡∏£‡∏™
});

btnRetake.addEventListener('click', () => {
  if (stream) { show(video); hide(preview); btnOCR.disabled = true; setStatus("‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà"); }
});

filePicker.addEventListener('change', async (e) => {
  const f = e.target.files?.[0];
  if (!f) return;
  const img = await fileToImage(f);
  drawToCanvas(img);
  currentImageDataUrl = canvas.toDataURL('image/jpeg', JPEG_QUALITY);
  preview.src = currentImageDataUrl;
  hide(video);
  show(preview);
  btnOCR.disabled = false;
  btnSubmit.disabled = false;
  setStatus("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ô OCR/‡∏™‡πà‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô");
});

/** ========= OCR ========= **/
btnOCR.addEventListener('click', async () => {
  if (!currentImageDataUrl) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û");
  btnOCR.disabled = true;
  setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á OCR (tha+eng)‚Ä¶ ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ~10‚Äì20 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ");
  ocrLog.classList.remove('d-none');
  ocrLog.textContent = "Loading Tesseract & language‚Ä¶";

  try {
    const worker = await Tesseract.createWorker(OCR_LANGS, 1, {
      logger: m => {
        if (m.status) ocrLog.textContent = `${m.status} ${m.progress ? (100*m.progress).toFixed(0)+'%' : ''}`;
      },
    });

    const result = await worker.recognize(currentImageDataUrl);
    await worker.terminate();

    rawOcrText = result.data.text || "";
    ocrLog.textContent = "== RAW OCR TEXT ==\n" + rawOcrText.slice(0, 5000);

    const fields = extractLikelyFields(rawOcrText);
    if (fields.fullName) inputFullName.value = fields.fullName;
    if (fields.idNumber) inputIdNumber.value = fields.idNumber;
    if (fields.dob) inputDob.value = fields.dob;
    if (fields.address) inputAddress.value = fields.address;

    setStatus("OCR ‡πÄ‡∏™‡∏£‡πá‡∏à ‚Äî ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏™‡πà‡∏á");
  } catch (err) {
    console.error(err);
    alert("OCR ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ");
    setStatus("OCR ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
  } finally {
    btnOCR.disabled = false;
  }
});

/** ========= SUBMIT ========= **/
document.getElementById('regForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!currentImageDataUrl) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á");

  // ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
  const idOK = /^\d{13}$/.test(inputIdNumber.value.trim());
  if (!idOK) return alert("‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å");

  const payload = {
    uid: crypto.randomUUID(),
    full_name: inputFullName.value.trim(),
    id_number: inputIdNumber.value.trim(),
    dob: inputDob.value.trim(),
    address: inputAddress.value.trim(),
    note: inputNote.value.trim(),
    image_data_url: currentImageDataUrl,
    raw_ocr_text: rawOcrText
  };

  btnSubmit.disabled = true;
  setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå (Apps Script)‚Ä¶");

  try {
    const res = await fetch(ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    if (data.ok) {
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: " + payload.uid);
      setStatus("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ä‡∏µ‡∏ï‡πÅ‡∏•‡πâ‡∏ß");
      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏ï‡πà‡∏≠)
      inputNote.value = "";
    } else {
      console.error(data);
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + (data.error || "unknown"));
      setStatus("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
    }
  } catch (err) {
    console.error(err);
    alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ENDPOINT ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Web App");
    setStatus("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  } finally {
    btnSubmit.disabled = false;
  }
});
</script>
</body>
</html>
